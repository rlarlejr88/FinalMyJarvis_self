<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.or.iei.contract.model.dao.ContractDao">	
	
	<sql id="searchFilterCondition">
    <where>
        <if test="memberNo != null and memberNo != ''">
            AND C.MEMBER_NO = #{memberNo}
        </if>
    </where>
	</sql>
	
	<!-- Ï†ÑÏ≤¥ Í≥ÑÏïΩ Ïàò Ï°∞Ìöå -->
	<select id="selectContractCount" parameterType="map" resultType="_int">
    SELECT count(*)
    FROM TBL_CONTRACT C
    JOIN TBL_MEMBER M ON C.MEMBER_NO = M.MEMBER_NO
    <include refid="searchFilterCondition" />
	</select>
	
	<!-- Ï†ÑÏ≤¥ Í≥ÑÏïΩ Î™©Î°ù Ï°∞Ìöå(ÎÖºÌéòÏù¥ÏßÄ) -->
	<select id="selectAllContractList" parameterType="map" resultType="Contract">
    SELECT
        C.CONTRACT_NO AS contractNo,
        C.STATUS_CODE AS statusCode,
        C.CONTRACT_TITLE AS contractTitle,
        C.CONTRACT_CONTENT AS contractContent,
        TO_CHAR(C.CONTRACT_START, 'YYYY-MM-DD') AS contractStart,
        TO_CHAR(C.CONTRACT_END, 'YYYY-MM-DD') AS contractEnd,
        C.CONTRACT_DEPOSIT AS contractDeposit,
        TO_CHAR(C.CONTRACT_CONFIRM, 'YYYY-MM-DD') AS contractConfirm,
        C.MEMBER_NO AS memberNo,
        M.MEMBER_NAME AS memberName,
        (
            SELECT CO.COMP_NAME
            FROM TBL_CONTRACT_PARTY CP
            JOIN TBL_COMPANY CO ON CP.COMP_CD = CO.COMP_CD
            WHERE CP.CONTRACT_NO = C.CONTRACT_NO AND ROWNUM = 1
        ) AS companyName
    FROM
        TBL_CONTRACT C
    LEFT JOIN
        TBL_MEMBER M ON C.MEMBER_NO = M.MEMBER_NO
        <include refid="searchFilterCondition" />
    ORDER BY
        C.CONTRACT_START DESC
	</select>	
	
	<!-- Ï†ÑÏ≤¥ Í≥ÑÏïΩ Î™©Î°ù Ï°∞Ìöå(ÌéòÏù¥ÏßÄÎ≥Ñ) -->
	<select id="selectContractList" parameterType="map" resultType="Contract">
    SELECT * 
      FROM (
      	   SELECT ROWNUM AS RNUM, A.* 
      	     FROM (
      	     	  SELECT C.CONTRACT_NO AS contractNo,
				    	 C.STATUS_CODE AS statusCode,
				    	 C.CONTRACT_TITLE AS contractTitle,
				    	 C.CONTRACT_CONTENT AS contractContent,
				    	 TO_CHAR(C.CONTRACT_START, 'YYYY-MM-DD') AS contractStart,
				    	 TO_CHAR(C.CONTRACT_END, 'YYYY-MM-DD') AS contractEnd,
				    	 C.CONTRACT_DEPOSIT AS contractDeposit,
				    	 TO_CHAR(C.CONTRACT_CONFIRM, 'YYYY-MM-DD') AS contractConfirm,
				    	 C.MEMBER_NO AS memberNo,
				    	 M.MEMBER_NAME AS memberName,
				    	 CO.COMP_NAME AS companyName
		    	    from TBL_CONTRACT C
			             LEFT JOIN TBL_MEMBER M ON C.MEMBER_NO = M.MEMBER_NO
					     LEFT JOIN TBL_CONTRACT_PARTY CP ON C.CONTRACT_NO = CP.CONTRACT_NO
					     LEFT JOIN TBL_COMPANY CO ON CP.COMP_CD = CO.COMP_CD
					     <include refid="searchFilterCondition" />
				   ORDER BY
				         C.CONTRACT_START DESC				    	 
      	          ) A 
           )
    	   WHERE rnum between #{pageInfo.start} and #{pageInfo.end}   
	</select>
	
	<!-- Í≥ÑÏïΩ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ -->
	<update id="updateContractStatus">
    UPDATE TBL_CONTRACT
       SET
           STATUS_CODE = #{statusCode}
     WHERE
           CONTRACT_NO = #{contractNo}
	</update>
	
	<!-- Í≥ÑÏïΩ ÏÉÅÌÉú Î≥ÄÍ≤Ω ÌûàÏä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä -->
	<insert id="insertContractHistory">
    INSERT INTO TBL_CONTRACT_HISTORY (
           CONTRACT_HISTORY_NO,
           CONTRACT_NO,
           CONTRACT_HISTORY_CONTENT,
           CONTRACT_HISTORY_DATE,
           MEMBER_NO -- Îã¥ÎãπÏûê Í∏∞Î°ùÏùÑ ÏúÑÌïú Ïª¨Îüº Ï∂îÍ∞Ä Í∂åÏû•
    ) VALUES (
	       SEQ_CONTRACT_HISTORY_NO.NEXTVAL,
	       #{contractNo},
	       #{contractHistoryContent},
	       SYSDATE,
	       #{memberNo}
    )
	</insert>
    
    <!-- Í≥ÑÏïΩ Ï∂îÍ∞Ä -->
    <insert id="insertContract" parameterType="Contract">
	    <selectKey keyProperty="contractNo" resultType="string" order="BEFORE">
	        SELECT 'CNO_' || LPAD(SEQ_TBL_CONTRACT_NO.NEXTVAL, 4, '0') FROM DUAL
	    </selectKey>
	    INSERT INTO TBL_CONTRACT (
	        CONTRACT_NO,
	        MEMBER_NO,
	        STATUS_CODE,
	        CONTRACT_TITLE,
	        CONTRACT_CONTENT,
	        CONTRACT_START,
	        CONTRACT_END,
	        CONTRACT_DEPOSIT
	    ) VALUES (
	        #{contractNo},
	        #{memberNo},
	        'T', 
	        #{contractTitle},
	        #{contractContent},
	        TO_DATE(#{contractStart}, 'YYYY-MM-DD'),
	        TO_DATE(#{contractEnd}, 'YYYY-MM-DD'),
	        #{contractDeposit}
	    )
	</insert>

	<insert id="insertContractParty" parameterType="ContractParty">
	    INSERT INTO TBL_CONTRACT_PARTY (
	        ID,
	        CONTRACT_NO,
	        COMP_CD,
	        MEMBER_NO,
	        ROLE,
	        CONTACT_IDX
	    ) VALUES (
	        SEQ_CONTRACT_PARTY_ID.NEXTVAL,
	        #{contractNo},
	        #{compCd},
	        #{memberNo}, 
	        #{role},
	        #{contactIdx}
	    )
	</insert>
	
	<!-- Í≥ÑÏïΩ ÏÉÅÏÑ∏ Ï°∞Ìöå -->
	<resultMap id="contractDetailMap" type="kr.or.iei.contract.model.dto.ContractDetailDto">
        <association property="companyInfo" javaType="kr.or.iei.company.model.dto.Company">
            <result column="COMP_NAME" property="compName"/>
            <result column="COMP_CD" property="compCd"/>
            <result column="OWNER_NAME" property="ownerName"/>
            <result column="COMP_NO" property="compNo"/>
        </association>
        <association property="contractInfo" javaType="kr.or.iei.contract.model.dto.ContractInfoDto">
            <result column="CONTRACT_NO" property="contractNo"/>
            <result column="CONTRACT_TITLE" property="contractTitle"/>
            <result column="CONTRACT_CONTENT" property="contractContent"/>
            <result column="CONTRACT_START" property="contractStart"/>
            <result column="CONTRACT_END" property="contractEnd"/>
            <result column="CONTRACT_DEPOSIT" property="contractDeposit"/>
            <result column="STATUS_CODE" property="statusCode"/>
        </association>
        <collection property="parties" select="selectContractParties" column="CONTRACT_NO" javaType="java.util.ArrayList" ofType="kr.or.iei.contract.model.dto.PartyDto" />
        <collection property="attachedFiles" select="selectContractFiles" column="CONTRACT_NO" javaType="java.util.ArrayList" ofType="kr.or.iei.common.model.dto.FileDTO" />
        <collection property="changeHistory" select="selectContractHistory" column="CONTRACT_NO" javaType="java.util.ArrayList" ofType="kr.or.iei.contract.model.dto.HistoryDto" />
        <collection property="memos" select="selectContractMemos" column="CONTRACT_NO" javaType="java.util.ArrayList" ofType="kr.or.iei.memo.model.dto.Memo" />
    </resultMap>

	<select id="selectOneContract" parameterType="string" resultMap="contractDetailMap">
	    SELECT
	        C.CONTRACT_NO,
	        C.CONTRACT_TITLE,
	        C.CONTRACT_CONTENT,
	        TO_CHAR(C.CONTRACT_START, 'YYYY-MM-DD') AS CONTRACT_START,
	        TO_CHAR(C.CONTRACT_END, 'YYYY-MM-DD') AS CONTRACT_END,
	        C.CONTRACT_DEPOSIT,
	        C.STATUS_CODE,
	        CO.COMP_CD,
	        CO.COMP_NAME,
	        CO.OWNER_NAME,
	        CO.COMP_NO
	    FROM TBL_CONTRACT C
	    -- üëá [ÌïµÏã¨ ÏàòÏ†ï] Ïù¥Ï†ú 'Í≥†Í∞ùÏÇ¨' Ïó≠Ìï†ÏùÑ Í∞ÄÏßÑ Ï∞∏Ïó¨ÏûêÎ•º Í∏∞Ï§ÄÏúºÎ°ú ÌöåÏÇ¨ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏ÏòµÎãàÎã§.
	    LEFT JOIN TBL_CONTRACT_PARTY CP ON C.CONTRACT_NO = CP.CONTRACT_NO AND CP.ROLE = 'Í≥†Í∞ùÏÇ¨'
	    LEFT JOIN TBL_COMPANY CO ON CP.COMP_CD = CO.COMP_CD
	    WHERE C.CONTRACT_NO = #{contractNo}
	</select>

    <select id="selectContractParties" parameterType="string" resultType="PartyDto">
	    SELECT 
	        -- 'ÎÇò'Ïùò Ï†ïÎ≥¥ ÎòêÎäî 'Í≥†Í∞ùÏÇ¨ Îã¥ÎãπÏûê' Ï†ïÎ≥¥Î•º Íµ¨Î∂ÑÌï¥ÏÑú Í∞ÄÏ†∏Ïò¥
	        NVL(M.MEMBER_NO, CM.CONTACT_IDX) AS partyId, -- Í≥†Ïú† ÏãùÎ≥ÑÏûê
	        NVL(M.MEMBER_NAME, CM.CONTACT_NAME) AS name, -- Ïù¥Î¶Ñ
	        NVL(M.MEMBER_EMAIL, CM.CONTACT_EMAIL) as email, -- Ïù¥Î©îÏùº (Ï∂îÍ∞Ä)
	        CP.ROLE AS role,
	        CP.SIGNED AS signed,
	        TO_CHAR(CP.SIGNED_DATE, 'YYYY-MM-DD') as signedDate,
	        CP.SIGNATURE_IMAGE as signatureImage
	    FROM TBL_CONTRACT_PARTY CP
	    LEFT JOIN TBL_MEMBER M ON CP.MEMBER_NO = M.MEMBER_NO
	    LEFT JOIN TBL_COMPANY_MEMBER CM ON CP.CONTACT_IDX = CM.CONTACT_IDX
	    WHERE CP.CONTRACT_NO = #{contractNo}
	</select>
	
    <select id="selectContractFiles" parameterType="string" resultType="kr.or.iei.common.model.dto.FileDTO">
        SELECT
            FILE_NO as fileNo,
            FILE_ORIGIN as fileOrigin,
            FILE_PATH as filePath
        FROM TBL_FILE
        WHERE FILE_TABLE = 'contract' AND FILE_ID = #{contractNo} AND FILE_DELETED = 'N'
    </select>
    
	<select id="selectContractHistory" resultType="kr.or.iei.contract.model.dto.HistoryDto">
    SELECT        
        H.CONTRACT_HISTORY_NO AS historyNo,
        H.CONTRACT_HISTORY_CONTENT AS changedItem,
        TO_CHAR(H.CONTRACT_HISTORY_DATE, 'YYYY-MM-DD HH24:MI') AS changeDate,
        M.MEMBER_NAME AS changer
    FROM TBL_CONTRACT_HISTORY H
    JOIN TBL_MEMBER M ON H.MEMBER_NO = M.MEMBER_NO
    WHERE H.CONTRACT_NO = #{contractNo}
    ORDER BY H.CONTRACT_HISTORY_DATE DESC
	</select>
    
    <select id="selectContractMemos" parameterType="string" resultType="kr.or.iei.memo.model.dto.Memo">
        SELECT
            MEMO_NO AS memoNo,
            MEMO_CONTENT AS memoContent,
            M.MEMBER_NAME AS writerName,
            TO_CHAR(REG_DATE, 'YYYY-MM-DD') AS writeDate
        FROM TBL_MEMO TM
        JOIN TBL_MEMBER M ON TM.MEMBER_NO = M.MEMBER_NO
        WHERE MEMO_TABLE = 'CONTRACT' AND MEMO_ID = #{contractNo}
        ORDER BY REG_DATE DESC
    </select>
    
    <update id="updateSignature" parameterType="SignatureUpdateDto">
	    UPDATE TBL_CONTRACT_PARTY
	    SET
	        SIGNED = 'Y',
	        SIGNED_DATE = SYSDATE,
	        SIGNATURE_IMAGE = #{signatureImage}
	    WHERE 
	        CONTRACT_NO = #{contractNo} 
	        AND (MEMBER_NO = #{partyId} OR CONTACT_IDX = #{partyId}) -- ‚óÄ [ÏàòÏ†ï] partyIdÎ°ú 'ÎÇò'ÏôÄ 'Í≥†Í∞ùÏÇ¨' Î™®ÎëêÎ•º Ï∞æÏùÑ Ïàò ÏûàÎèÑÎ°ù Î≥ÄÍ≤Ω
	</update>
	
	<!-- Í≥†Ïú† ÏÑúÎ™Ö ÌÜ†ÌÅ∞ÏúºÎ°ú Í≥ÑÏïΩ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå -->
	<select id="selectContractByToken" parameterType="string" resultMap="contractDetailMap">
    SELECT
        C.CONTRACT_NO,
        C.CONTRACT_TITLE,
        C.CONTRACT_CONTENT,
        TO_CHAR(C.CONTRACT_START, 'YYYY-MM-DD') AS CONTRACT_START,
        TO_CHAR(C.CONTRACT_END, 'YYYY-MM-DD') AS CONTRACT_END,
        C.CONTRACT_DEPOSIT,
        C.STATUS_CODE,
        CO.COMP_CD,
        CO.COMP_NAME,
        CO.OWNER_NAME,
        CO.COMP_NO
    FROM TBL_CONTRACT_PARTY CP_TOKEN
    JOIN TBL_CONTRACT C ON CP_TOKEN.CONTRACT_NO = C.CONTRACT_NO
    LEFT JOIN TBL_CONTRACT_PARTY CP ON C.CONTRACT_NO = CP.CONTRACT_NO AND CP.ROLE = 'ÎãπÏÇ¨Ïûê'
    LEFT JOIN TBL_COMPANY CO ON CP.COMP_CD = CO.COMP_CD
    WHERE CP_TOKEN.SIGN_TOKEN = #{signToken} AND ROWNUM = 1
	</select>
	
	<!-- Í≥µÍ∞ú ÏÑúÎ™Ö Ï†ÄÏû• API -->
	<update id="updateSignatureByToken" parameterType="kr.or.iei.contract.model.dto.SignatureUpdateDto">
    UPDATE TBL_CONTRACT_PARTY
    SET
        SIGNED = 'Y',
        SIGNED_DATE = SYSDATE,
        SIGNATURE_IMAGE = #{signatureImage}
    WHERE SIGN_TOKEN = #{signToken}
	</update>
	
	<!-- Í≥µÍ∞ú ÏÑúÎ™Ö Ï†ÄÏû• API -->
	<update id="updateSignToken">
    UPDATE TBL_CONTRACT_PARTY
    SET
        SIGN_TOKEN = #{signToken}
    WHERE 
        CONTRACT_NO = #{contractNo}         
        AND (MEMBER_NO = #{memberNo} OR CONTACT_IDX = #{memberNo})
	</update>
	
	<select id="getContractNoBySignToken" parameterType="string" resultType="string">
    SELECT CONTRACT_NO
    FROM TBL_CONTRACT_PARTY
    WHERE SIGN_TOKEN = #{signToken}
	</select>

	<select id="getMemberNoBySignToken" parameterType="string" resultType="string">
    SELECT MEMBER_NO
    FROM TBL_CONTRACT_PARTY
    WHERE SIGN_TOKEN = #{signToken}
	</select>
	
	<select id="getMemberNoByContractNo" parameterType="string" resultType="string">
    SELECT
        MEMBER_NO
    FROM TBL_CONTRACT
    WHERE CONTRACT_NO = #{contractNo}
	</select>
	
	
	<!-- Í≥†Í∞ùÏÇ¨ ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ > Í≥ÑÏïΩ Î™©Î°ù Ï°∞Ìöå -->
	<select id="selectContractListByCompany" parameterType="string" resultType="kr.or.iei.contract.model.dto.Contract">
    SELECT
        C.CONTRACT_NO           AS contractNo,
        CP.COMP_CD              AS compCd,
        CO.COMP_NAME            AS companyName,      -- compName -> companyName ÏúºÎ°ú ÏàòÏ†ï
        C.CONTRACT_TITLE        AS contractTitle,    -- contractName -> contractTitle ÏúºÎ°ú ÏàòÏ†ï
        C.STATUS_CODE           AS statusCode,       -- contractStatus -> statusCode ÏúºÎ°ú ÏàòÏ†ï
        C.CONTRACT_DEPOSIT      AS contractDeposit,  -- contractAmount -> contractDeposit ÏúºÎ°ú ÏàòÏ†ï
        TO_CHAR(C.CONTRACT_START, 'YYYY-MM-DD') AS contractStart,  -- contractStartDate -> contractStart ÏúºÎ°ú ÏàòÏ†ï
        TO_CHAR(C.CONTRACT_END, 'YYYY-MM-DD')   AS contractEnd      -- contractEndDate -> contractEnd ÏúºÎ°ú ÏàòÏ†ï
    FROM
        TBL_CONTRACT C
    JOIN
        TBL_CONTRACT_PARTY CP ON C.CONTRACT_NO = CP.CONTRACT_NO
    JOIN
        TBL_COMPANY CO ON CP.COMP_CD = CO.COMP_CD
    WHERE
        CP.COMP_CD = #{compCd}
    ORDER BY
        C.CONTRACT_START DESC
	</select>
  
</mapper>
